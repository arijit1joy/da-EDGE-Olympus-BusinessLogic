AWSTemplateFormatVersion: 2010-09-09
Description: >-
  The AWS CloudFormation template for deployment of the Edge Services. Version
  2.0
Parameters:
  ApplicationName:
    Type: String
  ApplicationEnvironmentTag:
    Type: String
  ArtifactsBucket:
    Type: String
  VersionId:
    Type: String
  CdoEnvironmentTag:
    Type: String
  EdgeCommonDBAPI:
    Type: String
  TsbUrl:
    Type: String
  RequestsPythonLayer:
    Type: AWS::SSM::Parameter::Value<String>
    Default: layer-RequestsPythonLayer
  EdgeCoreLayer:
    Type: AWS::SSM::Parameter::Value<String>
    Default: layer-EdgeCoreLayer
  PypikaPythonLayer:
    Type: AWS::SSM::Parameter::Value<String>
    Default: layer-CDAPypikaPythonLayer

Resources:
  #Emission Data Bucket
  EdgeJ1939EmissionDataLogBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      AccessControl: BucketOwnerFullControl
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      NotificationConfiguration:
        QueueConfigurations:
          - Queue: !Sub "arn:aws:sqs:${AWS::Region}:${AWS::AccountId}:${ApplicationName}-Emission-DataLogFilesQueue-${ApplicationEnvironmentTag}"
            Event: "s3:ObjectCreated:*"
      BucketName: !Sub "da-edge-j1939-emission-datalog-files-${ApplicationEnvironmentTag}"
      Tags:
        - Key: Name
          Value: Edge
        - Key: "appid"
          Value: "33439"
        - Key: "environment"
          Value: !Ref CdoEnvironmentTag
        - Key: "bu"
          Value: "CBS"
        - Key: "bc"
          Value: "007"
        - Key: "rc"
          Value: "A6Q"

  # Emission Data Processor Lambda Function
  EmissionDataProcessorLambda:
    Type: "AWS::Lambda::Function"
    Properties:
      Layers:
        - !Ref RequestsPythonLayer
        - !Ref PypikaPythonLayer
        - !Ref EdgeCoreLayer
      Code:
        S3Bucket: !Ref ArtifactsBucket
        S3Key: !Sub "${VersionId}/da-edge-emission-data-processor.zip"
      FunctionName: !Sub "${ApplicationName}-EmissionDataProcessor-${ApplicationEnvironmentTag}"
      Tags:
        - Value: SAM
          Key: "Lambda:CreatedBy"
        - Key: "appid"
          Value: "33439"
        - Key: "environment"
          Value: !Ref CdoEnvironmentTag
        - Key: "bu"
          Value: "CBS"
        - Key: "bc"
          Value: "007"
        - Key: "rc"
          Value: "A6Q"
      MemorySize: 1536
      # ReservedConcurrentExecutions: 275
      Environment:
        Variables:
          LoggingLevel: "debug"
          APPLICATION_NAME: !Ref ApplicationName
          region: !Sub "${AWS::Region}"
          APPLICATION_ENVIRONMENT: !Ref ApplicationEnvironmentTag
          j1939_emission_end_bucket: !Ref EdgeJ1939EmissionDataLogBucket
          edgeCommonAPIURL: !Ref EdgeCommonDBAPI
          tsb_url: !Ref TsbUrl
      Handler: lambda_function.lambda_handler
      Role: !GetAtt EmissionDataProcessorLambdaRole.Arn
      Timeout: 300
      Runtime: python3.9

  # Emission Data Processor Lambda Log Group
  EmissionDataProcessorLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${EmissionDataProcessorLambda}'
      RetentionInDays: 120 # 3 months, matches existing log group

  #Emission Data Processor Lambda Role
  EmissionDataProcessorLambdaRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Sub >-
        ${ApplicationName}-EmissionDataProcessorLambdaRole-${ApplicationEnvironmentTag}
      Path: /
      Policies:
        - PolicyName: !Sub >-
            ${ApplicationName}-EmissionDataProcessorLambdaPolicy-${ApplicationEnvironmentTag}
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Action:
                  - "logs:*"
                Resource: "arn:aws:logs:*:*:*"
                Effect: Allow
              - Action:
                  - "s3:Get*"
                Resource: !Sub "${EdgeJ1939EmissionDataLogBucket.Arn}/*"
                Effect: Allow
              - Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:DeleteMessageBatch
                  - sqs:GetQueueAttributes
                Resource: !Sub "${EDGEJ1939EmissionDataLogFilesQueue.Arn}"
                Effect: Allow
              - Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: "*"
                Effect: Allow
      Tags:
        - Key: "appid"
          Value: "33439"
        - Key: "environment"
          Value: !Ref CdoEnvironmentTag
        - Key: "bu"
          Value: "CBS"
        - Key: "bc"
          Value: "007"
        - Key: "rc"
          Value: "A6Q"
      AssumeRolePolicyDocument:
        Statement:
          - Action: "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com


Outputs:
  EdgeJ1939EmissionDataLogBucketResource:
    Description: The Emission data log bucket name
    Value: !Ref EdgeJ1939EmissionDataLogBucket
  EdgeJ1939EmissionDataLogBucketResourceArn:
    Description: The Emission data log bucket arn
    Value: !Sub "${EdgeJ1939EmissionDataLogBucket.Arn}"
